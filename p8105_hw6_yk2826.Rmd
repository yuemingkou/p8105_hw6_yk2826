---
title: "Homework 6"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
library(mgcv)
library("leaps")

knitr::opts_chunk$set(
  fig.width = 9,
  fig.asp = .8,
  out.width = "90%"
)
theme_set(theme_bw() + theme(legend.position = "bottom"))
set.seed(1)
```

## Problem 1

### Import and manipulate data

```{r read_data, message = FALSE, warning = FALSE}
homicide_df = 
  read_csv("./homicide-data.csv") %>% 
  mutate(city_state = str_c(city, ", ", state),
         resolved = as.numeric(disposition == "Closed by arrest")) %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", 
                             "Kansas City, MO", "Tulsa, AL"))) %>% 
  mutate(victim_race = ifelse(victim_race != "White", "Non-White", "White"),
         victim_race = fct_relevel(victim_race, "White"),
         victim_age = as.numeric(victim_age)) %>% 
  select(city_state, resolved, everything())

homicide_df
str(homicide_df)
```

This dataset contains `r nrow(homicide_df)` observations, where each observation is a case of homicide. There are 14 variables in this dataset, including the location of the killing, whether the homicide was solved and basic demographic information about each victim.

### For the city of Baltimore, MD

First, fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors. 
```{r logistic_regression}
baltimore_df = filter(homicide_df, city == "Baltimore")

fit_logistic = 
  baltimore_df %>% 
  glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial()) %>% 
  broom::tidy()
fit_logistic
```

Homicides in which the victim is non-white are substantially less likely to be resolved than those in which the victim is white. Homicides in which the victim is male are significantly less likely to be resolved than those in which the victim is female. The effect of age is statistically significant, but careful data inspections should be conducted before interpreting too deeply.

Then, obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed:

```{r odds_ratio}
fit_logistic %>% 
  filter(term == "victim_raceNon-White") %>% 
  mutate(OR = exp(estimate), 
         lower_limit = exp(estimate - qnorm(0.975)*std.error), 
         upper_limit = exp(estimate + qnorm(0.975)*std.error)) %>% 
  select(term, OR, lower_limit, upper_limit) %>% 
  knitr::kable(digits = 3)
```

The estimate of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed is 0.441 and the 95% confidence interval is (0.313, 0.620).

### For each city

Create a dataframe with estimated ORs and CIs for each city:

```{r ors_cis}
or_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(resolved_logistic = 
         map(data, ~glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())),
         resolved_logistic = map(resolved_logistic, broom::tidy)) %>% 
  select(city_state, resolved_logistic) %>% 
  unnest() %>% 
  filter(term == "victim_raceNon-White") %>% 
  mutate(OR = exp(estimate), 
         lower_limit = exp(estimate - qnorm(0.975)*std.error), 
         upper_limit = exp(estimate + qnorm(0.975)*std.error)) %>% 
  select(city_state, OR, lower_limit, upper_limit) 
or_df
```